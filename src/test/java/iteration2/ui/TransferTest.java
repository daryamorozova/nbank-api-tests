package iteration2.ui;

import com.codeborne.selenide.Condition;
import com.codeborne.selenide.Configuration;
import com.codeborne.selenide.Selectors;
import com.codeborne.selenide.Selenide;
import models.CreateAccountResponse;
import models.CreateUserRequest;
import models.DepositRequest;
import models.LoginUserRequest;
import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.Test;
import org.openqa.selenium.Alert;
import requests.skelethon.Endpoint;
import requests.skelethon.requesters.CrudRequester;
import requests.steps.AdminSteps;
import specs.RequestSpecs;
import specs.ResponseSpecs;

import java.util.Arrays;
import java.util.Map;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import static com.codeborne.selenide.Selenide.*;
import static io.restassured.RestAssured.given;
import static org.assertj.core.api.Assertions.assertThat;

public class TransferTest {

    @BeforeAll
    public static void setupSelenoid() {
        Configuration.remote = "http://localhost:4444/wd/hub";
        Configuration.baseUrl = "http://192.168.0.107:3000";
        Configuration.browser = "chrome";
        Configuration.browserSize = "1920x1080";

        Configuration.browserCapabilities.setCapability("selenoid:options",
                Map.of("enableVNC", true, "enableLog", true)
        );
    }

    @Test
    public void userCanTransferTest() {
        // –®–ê–ì–ò –ü–û –ù–ê–°–¢–†–û–ô–ö–ï –û–ö–†–£–ñ–ï–ù–ò–Ø
        // –®–ê–ì 1: –∞–¥–º–∏–Ω –ª–æ–≥–∏–Ω–∏—Ç—Å—è –≤ –±–∞–Ω–∫–µ
        // –®–ê–ì 2: –∞–¥–º–∏–Ω —Å–æ–∑–¥–∞–µ—Ç —é–∑–µ—Ä–∞1
        // –®–ê–ì 3: –∞–¥–º–∏–Ω —Å–æ–∑–¥–∞–µ—Ç —é–∑–µ—Ä–∞2
        // –®–ê–ì 4: —é–∑–µ—Ä1 –ª–æ–≥–∏–Ω–∏—Ç—Å—è –≤ –±–∞–Ω–∫–µ
        // –®–ê–ì 5: —é–∑–µ—Ä —Å–æ–∑–¥–∞–µ—Ç –∞–∫–∫–∞—É–Ω—Ç
        // –®–ê–ì 6: —é–∑–µ—Ä2 –ª–æ–≥–∏–Ω–∏—Ç—Å—è –≤ –±–∞–Ω–∫–µ
        // –®–ê–ì 7: —é–∑–µ—Ä2 —Å–æ–∑–¥–∞–µ—Ç –∞–∫–∫–∞—É–Ω—Ç

        CreateUserRequest userRequest1 = AdminSteps.createUser();
        CreateUserRequest userRequest2 = AdminSteps.createUser();

        String userAuthHeader1 = new CrudRequester(
                RequestSpecs.unauthSpec(),
                Endpoint.LOGIN,
                ResponseSpecs.requestReturnsOK())
                .post(LoginUserRequest.builder().username(userRequest1.getUsername()).password(userRequest1.getPassword()).build())
                .extract()
                .header("Authorization");

        // –°–æ–∑–¥–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è1
        CrudRequester crudRequester1 = new CrudRequester(
                RequestSpecs.authAsUser(userRequest1.getUsername(), userRequest1.getPassword()),
                Endpoint.ACCOUNTS,
                ResponseSpecs.entityWasCreated()
        );
        crudRequester1.post(null);

        // –®–ê–ì 11: –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è1

        CreateAccountResponse[] existingUserAccounts1 = given()
                .spec(RequestSpecs.authAsUser(userRequest1.getUsername(), userRequest1.getPassword()))
                .get("http://localhost:4111/api/v1/customer/accounts")
                .then().assertThat()
                .extract().as(CreateAccountResponse[].class);

        CreateAccountResponse createdAccount1 = existingUserAccounts1[0];
        assertThat(createdAccount1).isNotNull();
        String accountNumber1 = createdAccount1.getAccountNumber();


        //

        String userAuthHeader2 = new CrudRequester(
                RequestSpecs.unauthSpec(),
                Endpoint.LOGIN,
                ResponseSpecs.requestReturnsOK())
                .post(LoginUserRequest.builder().username(userRequest2.getUsername()).password(userRequest2.getPassword()).build())
                .extract()
                .header("Authorization");

        // –°–æ–∑–¥–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è2
        CrudRequester crudRequester2 = new CrudRequester(
                RequestSpecs.authAsUser(userRequest2.getUsername(), userRequest2.getPassword()),
                Endpoint.ACCOUNTS,
                ResponseSpecs.entityWasCreated()
        );
        crudRequester2.post(null);

        Selenide.open("/");
        executeJavaScript("localStorage.setItem('authToken', arguments[0]);", userAuthHeader2);
        Selenide.open("/dashboard");

        // –®–ê–ì 10: –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è2

        CreateAccountResponse[] existingUserAccounts2 = given()
                .spec(RequestSpecs.authAsUser(userRequest2.getUsername(), userRequest2.getPassword()))
                .get("http://localhost:4111/api/v1/customer/accounts")
                .then().assertThat()
                .extract().as(CreateAccountResponse[].class);

        CreateAccountResponse createdAccount2 = existingUserAccounts2[0];
        assertThat(createdAccount2).isNotNull();
        String accountNumber2 = createdAccount2.getAccountNumber();

        Double initialBalance2 = createdAccount2.getBalance();

        // –ù–∞—á–∞–ª—å–Ω—ã–π –¥–µ–ø–æ–∑–∏—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 2

        CrudRequester depositRequester = new CrudRequester(
                RequestSpecs.authAsUser(userRequest2.getUsername(), userRequest2.getPassword()),
                Endpoint.DEPOSIT,
                ResponseSpecs.requestReturnsOK()
        );
        depositRequester.post(DepositRequest.builder().id(createdAccount2.getId()).balance(5000.00).build());

        // –ø–µ—Ä–µ—á–∏—Ç–∞—Ç—å –±–∞–ª–∞–Ω—Å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –ø–æ—Å–ª–µ –¥–µ–ø–æ–∑–∏—Ç–∞
        CreateAccountResponse[] afterDeposit = given()
                .spec(RequestSpecs.authAsUser(userRequest2.getUsername(), userRequest2.getPassword()))
                .get("http://localhost:4111/api/v1/customer/accounts")
                .then().extract().as(CreateAccountResponse[].class);

        double balanceAfterDeposit = Arrays.stream(afterDeposit)
                .filter(a -> a.getAccountNumber().equals(accountNumber2))
                .findFirst().orElseThrow()
                .getBalance();

        // –®–ê–ì–ò –¢–ï–°–¢–ê
        // –®–ê–ì 8: —é–∑–µ—Ä2 –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–∞

        $(Selectors.byText("\uD83D\uDD04 Make a Transfer")).click();

        // –®–ê–ì 9: –ø—Ä–æ–≤–µ—Ä–∫–∞, –ø—Ä–æ–∏–∑–æ—à–µ–ª –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–µ–ø–æ–∑–∏—Ç–∞
        $(Selectors.byText("\uD83D\uDD04 Make a Transfer")).shouldBe(Condition.visible);

        // –®–ê–ì 12: –ø–µ—Ä–µ–≤–æ–¥ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞
        Double sumOfTransfer = 500.0;

        // —é–∑–µ—Ä 2 –Ω–∞–∂–∏–º–∞–µ—Ç –Ω–∞ –∫–Ω–æ–ø–∫—É üÜï New Transfer –∏ –≤–∏–¥–∏—Ç —Ñ–æ—Ä–º—É –ø–µ—Ä–µ–≤–æ–¥–∞
        $(Selectors.byText("\uD83C\uDD95 New Transfer")).click();
        $(Selectors.byText("Recipient Account Number:")).shouldBe(Condition.visible);

        // —é–∑–µ—Ä 2 –∑–∞–ø–æ–ª–Ω—è–µ—Ç —Ñ–æ—Ä–º—É —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–∞ –∏ –Ω–∞–∂–∏–º–∞–µ—Ç –Ω–∞ –∫–Ω–æ–ø–∫—É —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–∞
        $("select.form-control.account-selector")
                .shouldBe(Condition.visible)
                .selectOptionContainingText(accountNumber2);

        $("[placeholder='Enter recipient name']").setValue("Name");
        $("[placeholder='Enter recipient account number']").setValue(String.valueOf(accountNumber1));
        $("[placeholder='Enter amount']").setValue(String.valueOf(sumOfTransfer));
        $("#confirmCheck")
                .shouldBe(Condition.visible, Condition.enabled)
                .setSelected(true);

        $(Selectors.byText("üöÄ Send Transfer")).click();

        Alert alert = switchTo().alert();
        String alertText = alert.getText();

        assertThat(alertText).contains("‚úÖ Successfully transferred"); //‚úÖ Successfully transferred $100 to account ACC31!

        alert.accept();

        Pattern pattern = Pattern.compile(STR."Successfully transferred $\{sumOfTransfer}");
        Matcher matcher = pattern.matcher(alertText);

        matcher.find();

        // –®–ê–ì 9: –ø—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –±–∞–ª–∞–Ω—Å —é–∑–µ—Ä–∞1 –±—ã–ª –ø–æ–ø–æ–ª–Ω–µ–Ω

        CreateAccountResponse[] accounts1 = given()
                .spec(RequestSpecs.authAsUser(userRequest1.getUsername(), userRequest1.getPassword()))
                .get("http://localhost:4111/api/v1/customer/accounts")
                .then().extract().as(CreateAccountResponse[].class);

        CreateAccountResponse updated1 = Arrays.stream(accounts1)
                .filter(a -> a.getAccountNumber().equals(accountNumber1))
                .findFirst().orElseThrow();

        assertThat(updated1.getBalance()).isEqualTo(sumOfTransfer);


        // –®–ê–ì 9: –ø—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –±–∞–ª–∞–Ω—Å —é–∑–µ—Ä–∞2 —Å—Ç–∞–ª –º–µ–Ω—å—à–µ

        CreateAccountResponse[] accounts2 = given()
                .spec(RequestSpecs.authAsUser(userRequest2.getUsername(), userRequest2.getPassword()))
                .get("http://localhost:4111/api/v1/customer/accounts")
                .then().extract().as(CreateAccountResponse[].class);

        CreateAccountResponse updated2 = Arrays.stream(accounts2)
                .filter(a -> a.getAccountNumber().equals(accountNumber2))
                .findFirst().orElseThrow();

        double expectedBalance2 = balanceAfterDeposit - sumOfTransfer;
        assertThat(updated2.getBalance()).isEqualTo(expectedBalance2);
    }


    @Test
    public void userCanNotTransferTest() {
        // –®–ê–ì–ò –ü–û –ù–ê–°–¢–†–û–ô–ö–ï –û–ö–†–£–ñ–ï–ù–ò–Ø
        // –®–ê–ì 1: –∞–¥–º–∏–Ω –ª–æ–≥–∏–Ω–∏—Ç—Å—è –≤ –±–∞–Ω–∫–µ
        // –®–ê–ì 2: –∞–¥–º–∏–Ω —Å–æ–∑–¥–∞–µ—Ç —é–∑–µ—Ä–∞1
        // –®–ê–ì 3: –∞–¥–º–∏–Ω —Å–æ–∑–¥–∞–µ—Ç —é–∑–µ—Ä–∞2
        // –®–ê–ì 4: —é–∑–µ—Ä1 –ª–æ–≥–∏–Ω–∏—Ç—Å—è –≤ –±–∞–Ω–∫–µ
        // –®–ê–ì 5: —é–∑–µ—Ä —Å–æ–∑–¥–∞–µ—Ç –∞–∫–∫–∞—É–Ω—Ç
        // –®–ê–ì 6: —é–∑–µ—Ä2 –ª–æ–≥–∏–Ω–∏—Ç—Å—è –≤ –±–∞–Ω–∫–µ
        // –®–ê–ì 7: —é–∑–µ—Ä2 —Å–æ–∑–¥–∞–µ—Ç –∞–∫–∫–∞—É–Ω—Ç

        CreateUserRequest userRequest1 = AdminSteps.createUser();
        CreateUserRequest userRequest2 = AdminSteps.createUser();

        String userAuthHeader1 = new CrudRequester(
                RequestSpecs.unauthSpec(),
                Endpoint.LOGIN,
                ResponseSpecs.requestReturnsOK())
                .post(LoginUserRequest.builder().username(userRequest1.getUsername()).password(userRequest1.getPassword()).build())
                .extract()
                .header("Authorization");

        // –°–æ–∑–¥–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è1
        CrudRequester crudRequester1 = new CrudRequester(
                RequestSpecs.authAsUser(userRequest1.getUsername(), userRequest1.getPassword()),
                Endpoint.ACCOUNTS,
                ResponseSpecs.entityWasCreated()
        );
        crudRequester1.post(null);

        // –®–ê–ì 11: –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è1

        CreateAccountResponse[] existingUserAccounts1 = given()
                .spec(RequestSpecs.authAsUser(userRequest1.getUsername(), userRequest1.getPassword()))
                .get("http://localhost:4111/api/v1/customer/accounts")
                .then().assertThat()
                .extract().as(CreateAccountResponse[].class);

        CreateAccountResponse createdAccount1 = existingUserAccounts1[0];
        assertThat(createdAccount1).isNotNull();
        String accountNumber1 = createdAccount1.getAccountNumber();


        //

        String userAuthHeader2 = new CrudRequester(
                RequestSpecs.unauthSpec(),
                Endpoint.LOGIN,
                ResponseSpecs.requestReturnsOK())
                .post(LoginUserRequest.builder().username(userRequest2.getUsername()).password(userRequest2.getPassword()).build())
                .extract()
                .header("Authorization");

        // –°–æ–∑–¥–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è2
        CrudRequester crudRequester2 = new CrudRequester(
                RequestSpecs.authAsUser(userRequest2.getUsername(), userRequest2.getPassword()),
                Endpoint.ACCOUNTS,
                ResponseSpecs.entityWasCreated()
        );
        crudRequester2.post(null);

        Selenide.open("/");
        executeJavaScript("localStorage.setItem('authToken', arguments[0]);", userAuthHeader2);
        Selenide.open("/dashboard");

        // –®–ê–ì 10: –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è2

        CreateAccountResponse[] existingUserAccounts2 = given()
                .spec(RequestSpecs.authAsUser(userRequest2.getUsername(), userRequest2.getPassword()))
                .get("http://localhost:4111/api/v1/customer/accounts")
                .then().assertThat()
                .extract().as(CreateAccountResponse[].class);

        CreateAccountResponse createdAccount2 = existingUserAccounts2[0];
        assertThat(createdAccount2).isNotNull();
        String accountNumber2 = createdAccount2.getAccountNumber();

        Double initialBalance2 = createdAccount2.getBalance();

        // –ù–∞—á–∞–ª—å–Ω—ã–π –¥–µ–ø–æ–∑–∏—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 2

        CrudRequester depositRequester = new CrudRequester(
                RequestSpecs.authAsUser(userRequest2.getUsername(), userRequest2.getPassword()),
                Endpoint.DEPOSIT,
                ResponseSpecs.requestReturnsOK()
        );
        depositRequester.post(DepositRequest.builder().id(createdAccount2.getId()).balance(5000.00).build());

        // –ø–µ—Ä–µ—á–∏—Ç–∞—Ç—å –±–∞–ª–∞–Ω—Å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –ø–æ—Å–ª–µ –¥–µ–ø–æ–∑–∏—Ç–∞
        CreateAccountResponse[] afterDeposit = given()
                .spec(RequestSpecs.authAsUser(userRequest2.getUsername(), userRequest2.getPassword()))
                .get("http://localhost:4111/api/v1/customer/accounts")
                .then().extract().as(CreateAccountResponse[].class);

        double balanceAfterDeposit = Arrays.stream(afterDeposit)
                .filter(a -> a.getAccountNumber().equals(accountNumber2))
                .findFirst().orElseThrow()
                .getBalance();

        // –®–ê–ì–ò –¢–ï–°–¢–ê
        // –®–ê–ì 8: —é–∑–µ—Ä2 –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–∞

        $(Selectors.byText("\uD83D\uDD04 Make a Transfer")).click();

        // –®–ê–ì 9: –ø—Ä–æ–≤–µ—Ä–∫–∞, –ø—Ä–æ–∏–∑–æ—à–µ–ª –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–µ–ø–æ–∑–∏—Ç–∞
        $(Selectors.byText("\uD83D\uDD04 Make a Transfer")).shouldBe(Condition.visible);

        // –®–ê–ì 12: –ø–µ—Ä–µ–≤–æ–¥ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞
        Double sumOfTransfer = 100000.0;

        // —é–∑–µ—Ä 2 –Ω–∞–∂–∏–º–∞–µ—Ç –Ω–∞ –∫–Ω–æ–ø–∫—É üÜï New Transfer –∏ –≤–∏–¥–∏—Ç —Ñ–æ—Ä–º—É –ø–µ—Ä–µ–≤–æ–¥–∞
        $(Selectors.byText("\uD83C\uDD95 New Transfer")).click();
        $(Selectors.byText("Recipient Account Number:")).shouldBe(Condition.visible);

        // —é–∑–µ—Ä 2 –∑–∞–ø–æ–ª–Ω—è–µ—Ç —Ñ–æ—Ä–º—É —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–∞ –∏ –Ω–∞–∂–∏–º–∞–µ—Ç –Ω–∞ –∫–Ω–æ–ø–∫—É —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–∞
        $("select.form-control.account-selector")
                .shouldBe(Condition.visible)
                .selectOptionContainingText(accountNumber2);

        $("[placeholder='Enter recipient name']").setValue("Name");
        $("[placeholder='Enter recipient account number']").setValue(String.valueOf(accountNumber1));
        $("[placeholder='Enter amount']").setValue(String.valueOf(sumOfTransfer));
        $("#confirmCheck")
                .shouldBe(Condition.visible, Condition.enabled)
                .setSelected(true);

        $(Selectors.byText("üöÄ Send Transfer")).click();

        Alert alert = switchTo().alert();
        String alertText = alert.getText();

        assertThat(alertText).contains("‚ùå Error: Transfer amount cannot exceed 10000");

        alert.accept();

        // –®–ê–ì 9: –ø—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –±–∞–ª–∞–Ω—Å —é–∑–µ—Ä–∞1 –±—ã–ª –ø–æ–ø–æ–ª–Ω–µ–Ω

        CreateAccountResponse[] accounts1 = given()
                .spec(RequestSpecs.authAsUser(userRequest1.getUsername(), userRequest1.getPassword()))
                .get("http://localhost:4111/api/v1/customer/accounts")
                .then().extract().as(CreateAccountResponse[].class);

        CreateAccountResponse updated1 = Arrays.stream(accounts1)
                .filter(a -> a.getAccountNumber().equals(accountNumber1))
                .findFirst().orElseThrow();

        assertThat(updated1.getBalance()).isZero();


        // –®–ê–ì 9: –ø—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –±–∞–ª–∞–Ω—Å —é–∑–µ—Ä–∞2 —Å—Ç–∞–ª –º–µ–Ω—å—à–µ

        CreateAccountResponse[] accounts2 = given()
                .spec(RequestSpecs.authAsUser(userRequest2.getUsername(), userRequest2.getPassword()))
                .get("http://localhost:4111/api/v1/customer/accounts")
                .then().extract().as(CreateAccountResponse[].class);

        CreateAccountResponse updated2 = Arrays.stream(accounts2)
                .filter(a -> a.getAccountNumber().equals(accountNumber2))
                .findFirst().orElseThrow();

        double expectedBalance2 = balanceAfterDeposit;
        assertThat(updated2.getBalance()).isEqualTo(expectedBalance2);
    }
}
